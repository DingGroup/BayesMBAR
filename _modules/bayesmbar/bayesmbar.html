
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bayesmbar.bayesmbar &#8212; BayesMBAR  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/bayesmbar/bayesmbar';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="BayesMBAR  documentation - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="BayesMBAR  documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installing BayesMBAR</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples.html">Examples</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/bayesmbar_for_harmonic_oscillators.html">BayesMBAR for harmonic oscillators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/cbayesmbar_for_harmonic_oscillators.html">CBayesMBAR for harmonic oscillators</a></li>
</ul>
</details></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../API.html">API</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/DingGroup/BayesMBAR" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for bayesmbar.bayesmbar</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">NDArray</span>
<span class="kn">import</span> <span class="nn">jax</span>

<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">hessian</span><span class="p">,</span> <span class="n">jit</span><span class="p">,</span> <span class="n">value_and_grad</span>
<span class="kn">from</span> <span class="nn">jax</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">blackjax</span>
<span class="kn">from</span> <span class="nn">optax</span> <span class="kn">import</span> <span class="n">sgd</span>
<span class="kn">import</span> <span class="nn">optax</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">fmin_newton</span><span class="p">,</span>
    <span class="n">_compute_log_likelihood_of_dF</span><span class="p">,</span>
    <span class="n">_compute_log_likelihood_of_F</span><span class="p">,</span>
    <span class="n">_compute_loss_likelihood_of_dF</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">jax</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;jax_enable_x64&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="BayesMBAR">
<a class="viewcode-back" href="../../API.html#bayesmbar.BayesMBAR">[docs]</a>
<span class="k">class</span> <span class="nc">BayesMBAR</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bayesian Multistate Bennett Acceptance Ratio (BayesMBAR) method&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">energy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">num_conf</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">prior</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
        <span class="n">mean</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;quadratic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span>
        <span class="n">kernel</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;SE&quot;</span><span class="p">,</span> <span class="s2">&quot;Matern52&quot;</span><span class="p">,</span> <span class="s2">&quot;Matern32&quot;</span><span class="p">,</span> <span class="s2">&quot;RQ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SE&quot;</span><span class="p">,</span>
        <span class="n">state_cv</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">warmup_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
        <span class="n">optimize_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            energy (np.ndarray): Energy matrix of shape (m, n), where m is the number of states and n is the number of configurations.</span>
<span class="sd">            num_conf (np.ndarray): Number of configurations in each state. It is a 1D array of length m.</span>
<span class="sd">            prior (str, optional): Prior distribution of dF. It can be either &quot;uniform&quot; or &quot;normal&quot;. Defaults to &quot;uniform&quot;.</span>
<span class="sd">            mean (str, optional): Mean function of the prior. It can be either &quot;constant&quot;, &quot;linear&quot;, or &quot;quadratic&quot;. Defaults to &quot;constant&quot;.</span>
<span class="sd">            kernel (str, optional): Kernel function of the prior. It can be either &quot;SE&quot;, &quot;Matern52&quot;, &quot;Matern32&quot;, or &quot;RQ&quot;. Defaults to &quot;SE&quot;.</span>
<span class="sd">            state_cv (np.ndarray, optional): State collective variables. It is a 2D array of shape (n, d), where n is the number of configurations and d is the dimension of the collective variables. Defaults to None.</span>
<span class="sd">            sample_size (int, optional): Number of samples drawn from the posterior distribution. Defaults to 1000.</span>
<span class="sd">            warmup_steps (int, optional): Number of warmup steps used to find the step size and mass matrix of the NUTS sampler. Defaults to 500.</span>
<span class="sd">            optimize_steps (int, optional): Number of optimization steps used to learn the hyperparameters when normal priors are used. Defaults to 10000.</span>
<span class="sd">            verbose (bool, optional): Whether to print the progress bar for the optimization and sampling. Defaults to True.</span>
<span class="sd">            random_seed (int, optional): Random seed. Defaults to 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_energy</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">num_conf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">=</span> <span class="n">prior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mean_name</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_name</span> <span class="o">=</span> <span class="n">kernel</span>

        <span class="k">if</span> <span class="n">state_cv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state_cv</span> <span class="o">=</span> <span class="n">state_cv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_steps</span> <span class="o">=</span> <span class="n">warmup_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_steps</span> <span class="o">=</span> <span class="n">optimize_steps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># We first compute the mode estimate based on the likelihood</span>
        <span class="c1"># because it is used in both the uniform and normal priors.</span>
        <span class="c1"># The mode estimate based on the likelihood is the solution to the MBAR equation.</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solve for the mode of the likelihood&quot;</span><span class="p">)</span>
        <span class="n">dF_init</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">_compute_loss_likelihood_of_dF</span><span class="p">))</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">hessian</span><span class="p">(</span><span class="n">_compute_loss_likelihood_of_dF</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fmin_newton</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">dF_init</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_energy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="p">))</span>
        <span class="n">dF</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mode_ll</span> <span class="o">=</span> <span class="n">dF</span>

        <span class="c1"># sample dF based on the likelihood.</span>
        <span class="c1"># When the uniform prior is used, the posterior distribution of dF is </span>
        <span class="c1"># the same as the likelihood function.</span>
        <span class="c1"># Thefore so these samples are also samples from the posterior</span>
        <span class="c1"># distribution of dF when the uniform prior is used.</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=====================================================&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sample from the likelihood&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rng_key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rng_key</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">logdensity</span><span class="p">(</span><span class="n">dF</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_compute_log_likelihood_of_dF</span><span class="p">(</span><span class="n">dF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dF_samples_ll</span> <span class="o">=</span> <span class="n">_sample_from_logdensity</span><span class="p">(</span>
            <span class="n">subkey</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mode_ll</span><span class="p">,</span>
            <span class="n">logdensity</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_steps</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sample_size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1">## compute the mean, covariance, and precision of dF based on the samples from the likelihood</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mean_ll</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dF_samples_ll</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dF_cov_ll</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dF_samples_ll</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="n">L</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dF_cov_ll</span><span class="p">)</span>
        <span class="n">L_inv</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve_triangular</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dF_prec_ll</span> <span class="o">=</span> <span class="n">L_inv</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">L_inv</span><span class="p">)</span>
        <span class="c1"># self._dF_prec_ll = jnp.linalg.inv(self._dF_cov_ll)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_F_mode_ll</span> <span class="o">=</span> <span class="n">_dF_to_F</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dF_mode_ll</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_F_samples_ll</span> <span class="o">=</span> <span class="n">_dF_to_F</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dF_samples_ll</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_F_mean_ll</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_samples_ll</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_F_cov_ll</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_samples_ll</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1">## we are done here if the prior is uniform.</span>
        <span class="c1">## When normal prior is used, we need to learn the hyperparameters of the prior and then sample dF from the posterior distribution of dF.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;energy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energy</span><span class="p">,</span>
                <span class="s2">&quot;num_conf&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="p">,</span>
                <span class="s2">&quot;dF_mean_ll&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mean_ll</span><span class="p">,</span>
                <span class="s2">&quot;dF_prec_ll&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dF_prec_ll</span><span class="p">,</span>
                <span class="s2">&quot;state_cv&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_cv</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1">## mean function of the prior</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean_name</span> <span class="o">==</span> <span class="s2">&quot;constant&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_order</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_mean</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mean_order</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean_name</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_order</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_mean</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mean_order</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean_name</span> <span class="o">==</span> <span class="s2">&quot;quadratic&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_order</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_mean</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mean_order</span><span class="p">)</span>

            <span class="c1">## learn the hyperparameters of the prior</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_name</span> <span class="o">==</span> <span class="s2">&quot;SE&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">_kernel_SE</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_name</span> <span class="o">==</span> <span class="s2">&quot;Matern52&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">_kernel_Matern52</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_name</span> <span class="o">==</span> <span class="s2">&quot;Matern32&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">_kernel_Matern32</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_name</span> <span class="o">==</span> <span class="s2">&quot;RQ&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">_kernel_RQ</span>

            <span class="c1">## initialize the hyperparameters based on the mode of the likelihood</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">_init_params</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mean_order</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mode_ll</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_cv</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">raw_params</span> <span class="o">=</span> <span class="n">_params_to_raw</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

            <span class="c1">## optimize the hyperparameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rng_key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rng_key</span><span class="p">)</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">sgd</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">nesterov</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">opt_state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">raw_params</span><span class="p">)</span>

            <span class="nd">@partial</span><span class="p">(</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnames</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;kernel&quot;</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">raw_params</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
                <span class="n">loss</span><span class="p">,</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">_compute_elbo_loss</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">raw_params</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">update</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">grads</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">)</span>
                <span class="n">raw_params</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">apply_updates</span><span class="p">(</span><span class="n">raw_params</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">raw_params</span><span class="p">,</span> <span class="n">opt_state</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">optimize_steps</span><span class="p">):</span>
                <span class="n">loss</span><span class="p">,</span> <span class="n">raw_params</span><span class="p">,</span> <span class="n">opt_state</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span>
                    <span class="n">subkey</span><span class="p">,</span> <span class="n">raw_params</span><span class="p">,</span> <span class="n">opt_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="n">_data</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rng_key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rng_key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">_params_from_raw</span><span class="p">(</span><span class="n">raw_params</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;step: </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">&gt;10d</span><span class="si">}</span><span class="s2">, loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">:</span><span class="s2">10.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_print_params</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">_params_from_raw</span><span class="p">(</span><span class="n">raw_params</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mean_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_cv</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dF_cov_prior</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state_cv</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dF_prec_prior</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dF_cov_prior</span><span class="p">)</span>

            <span class="c1">## solve for the mode of the posterior</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">_compute_loss_joint_likelihood_of_dF</span><span class="p">))</span>
            <span class="n">hess</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span><span class="n">hessian</span><span class="p">(</span><span class="n">_compute_loss_joint_likelihood_of_dF</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">fmin_newton</span><span class="p">(</span>
                <span class="n">f</span><span class="p">,</span>
                <span class="n">hess</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mode_ll</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_energy</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mean_prior</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dF_prec_prior</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mode_posterior</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>

            <span class="c1">## sample dF from the posterior</span>
            <span class="k">def</span> <span class="nf">logdensity</span><span class="p">(</span><span class="n">dF</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_compute_log_joint_likelihood_of_dF</span><span class="p">(</span>
                    <span class="n">dF</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_energy</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mean_prior</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dF_prec_prior</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_rng_key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rng_key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dF_samples_posterior</span> <span class="o">=</span> <span class="n">_sample_from_logdensity</span><span class="p">(</span>
                <span class="n">subkey</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mode_posterior</span><span class="p">,</span>
                <span class="n">logdensity</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_warmup_steps</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sample_size</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dF_mean_posterior</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dF_samples_posterior</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dF_cov_posterior</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dF_samples_posterior</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dF_prec_posterior</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dF_cov_posterior</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_F_mode_posterior</span> <span class="o">=</span> <span class="n">_dF_to_F</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dF_mode_posterior</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_F_samples_posterior</span> <span class="o">=</span> <span class="n">_dF_to_F</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dF_samples_posterior</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_F_mean_posterior</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_samples_posterior</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_F_cov_posterior</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_samples_posterior</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">F_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The posterior mode estimate of the free energies of the states under the constraints that :math:`\sum_{k=1}^{M} N_k * F_k = 0`, where :math:`N_k` and :math:`F_k` are the number of conformations and the free energy of the k-th state, respectively.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
            <span class="n">F_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_mode_ll</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">F_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_mode_posterior</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span><span class="n">F_mode</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">F_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The posterior mean of the free energies of the states under the constraints that :math:`\\sum_{k=1}^{M} N_k * F_k = 0`, where :math:`N_k` and :math:`F_k` are the number of conformations and the free energy of the k-th state, respectively.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
            <span class="n">F_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_mean_ll</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">F_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_mean_posterior</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span><span class="n">F_mean</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">F_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The posterior covariance matrix of the free energies of the states under the constraints that :math:`\\sum_{k=1}^{M} N_k * F_k = 0`, where :math:`N_k` and :math:`F_k` are the number of conformations and the free energy of the k-th state, respectively.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
            <span class="n">F_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_cov_ll</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">F_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_cov_posterior</span>
        <span class="n">F_cov</span> <span class="o">=</span> <span class="n">F_cov</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_conf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1">## if the diagnoal elements of F_cov are negetive, set them to 1e-4</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">F_cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F_cov</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">F_cov</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="n">F_cov</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span><span class="n">F_cov</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">F_std</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The posterior standard deviation of the free energies of the states under the constraints that :math:`\\sum_{k=1}^{M} N_k * F_k = 0`, where :math:`N_k` and :math:`F_k` are the number of conformations and the free energy of the k-th state, respectively.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_cov</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">F_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The samples of the free energies of the states from the posterior distribution under the constraints that :math:`\\sum_{k=1}^{M} N_k * F_k = 0`, where :math:`N_k` and :math:`F_k` are the number of conformations and the free energy of the k-th state, respectively.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
            <span class="n">F_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_samples_ll</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">F_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_samples_posterior</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span><span class="n">F_samples</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">DeltaF_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The posterior mode estimate of free energy difference between states.</span>
<span class="sd">        DeltaF_mode[i,j] is the free energy difference between state :math:`j` and state :math:`i`,</span>
<span class="sd">        i.e., DeltaF_mode[i,j] = F_mode[j] - F_mode[i].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_mode</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_mode</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">DeltaF_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The posterior mean of free energy difference between states.</span>
<span class="sd">        DeltaF_mean[i,j] is the free energy difference between state :math:`j` and state :math:`i`,</span>
<span class="sd">        i.e., DeltaF_mean[i,j] = F_mean[j] - F_mean[i].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_mean</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_mean</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">DeltaF_std</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The posterior standard deviation of free energy difference between states.</span>
<span class="sd">        DeltaF_std[i,j] is the posterior standard deviation of the free energy difference between state :math:`j` and state :math:`i`,</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">DeltaF_cov</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_cov</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_cov</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_cov</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">DeltaF_cov</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_dF_to_F</span><span class="p">(</span><span class="n">dF</span><span class="p">,</span> <span class="n">num_conf</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dF</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span> <span class="n">dF</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">dF</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dF</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">num_conf</span> <span class="o">/</span> <span class="n">num_conf</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">F</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">F</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">F</span>


<span class="k">def</span> <span class="nf">_compute_loss_joint_likelihood_of_dF</span><span class="p">(</span><span class="n">dF</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">num_conf</span><span class="p">,</span> <span class="n">mean_prior</span><span class="p">,</span> <span class="n">prec_prior</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the loss function of dF based on the joint likelihood.</span>

<span class="sd">    The logarithm of the joint likelihood of dF scales with the number of configurations and the number of states. To make the loss function semi-invariant to the number of configurations and the number of states, we divide the log likelihood by the total number of configurations and the number of states. This helps to set a single tolerance for the optimization algorithm used to compute the MAP estimate.</span>

<span class="sd">    See the doc of _compute_log_joint_likelihood_of_dF for more details on the arguments and the return value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">_compute_log_joint_likelihood_of_dF</span><span class="p">(</span>
        <span class="n">dF</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">num_conf</span><span class="p">,</span> <span class="n">mean_prior</span><span class="p">,</span> <span class="n">prec_prior</span>
    <span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">energy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">energy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>


<span class="k">def</span> <span class="nf">_compute_log_joint_likelihood_of_dF</span><span class="p">(</span><span class="n">dF</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">num_conf</span><span class="p">,</span> <span class="n">mean_prior</span><span class="p">,</span> <span class="n">prec_prior</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the logarithm of the joint likelihood of dF when the prior is a normal distribution.</span>

<span class="sd">    The joint likelihood is defined by the right hand side of Eq. (9) in the reference paper.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        dF (jnp.ndarray): Free energy differences</span>
<span class="sd">        energy (jnp.ndarray): Energy matrix</span>
<span class="sd">        num_conf (jnp.ndarray): Number of configurations in each state</span>
<span class="sd">        mean_prior (jnp.ndarray): Mean of the prior</span>
<span class="sd">        prec_prior (jnp.ndarray): Precision matrix of the prior</span>

<span class="sd">    Returns:</span>
<span class="sd">        jnp.ndarray: Logarithm of the joint likelihood of dF</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dF</span> <span class="o">-</span> <span class="n">mean_prior</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">prec_prior</span><span class="p">,</span> <span class="n">dF</span> <span class="o">-</span> <span class="n">mean_prior</span><span class="p">))</span>
    <span class="n">logp</span> <span class="o">=</span> <span class="n">logp</span> <span class="o">+</span> <span class="n">_compute_log_likelihood_of_dF</span><span class="p">(</span><span class="n">dF</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">num_conf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logp</span>


<span class="nd">@partial</span><span class="p">(</span><span class="n">value_and_grad</span><span class="p">,</span> <span class="n">argnums</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_compute_elbo_loss</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">raw_params</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">energy</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">]</span>
    <span class="n">num_conf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;num_conf&quot;</span><span class="p">]</span>
    <span class="n">state_cv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;state_cv&quot;</span><span class="p">]</span>
    <span class="n">dF_prec_ll</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dF_prec_ll&quot;</span><span class="p">]</span>
    <span class="n">dF_mean_ll</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dF_mean_ll&quot;</span><span class="p">]</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">_params_from_raw</span><span class="p">(</span><span class="n">raw_params</span><span class="p">)</span>
    <span class="n">mean_prior</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="n">state_cv</span><span class="p">)</span>
    <span class="n">cov_prior</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">],</span> <span class="n">state_cv</span><span class="p">)</span>
    <span class="n">mu_prop</span><span class="p">,</span> <span class="n">cov_prop</span> <span class="o">=</span> <span class="n">_compute_proposal_dist</span><span class="p">(</span>
        <span class="n">mean_prior</span><span class="p">,</span> <span class="n">cov_prior</span><span class="p">,</span> <span class="n">dF_mean_ll</span><span class="p">,</span> <span class="n">dF_prec_ll</span>
    <span class="p">)</span>
    <span class="n">dFs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">mu_prop</span><span class="p">,</span> <span class="n">cov_prop</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1024</span><span class="p">,))</span>
    <span class="n">Fs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dFs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dFs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">elbo</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">_compute_log_likelihood_of_F</span><span class="p">,</span> <span class="n">in_axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))(</span>
        <span class="n">Fs</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">num_conf</span>
    <span class="p">)</span>
    <span class="n">elbo</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">elbo</span><span class="p">)</span>
    <span class="n">elbo</span> <span class="o">=</span> <span class="n">elbo</span> <span class="o">-</span> <span class="n">_compute_kl_divergence</span><span class="p">(</span><span class="n">mu_prop</span><span class="p">,</span> <span class="n">cov_prop</span><span class="p">,</span> <span class="n">mean_prior</span><span class="p">,</span> <span class="n">cov_prior</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">elbo</span>


<span class="k">def</span> <span class="nf">_compute_kl_divergence</span><span class="p">(</span><span class="n">mu0</span><span class="p">,</span> <span class="n">cov0</span><span class="p">,</span> <span class="n">mu1</span><span class="p">,</span> <span class="n">cov1</span><span class="p">):</span>
    <span class="n">L0</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">cov0</span><span class="p">)</span>
    <span class="n">L1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">cov1</span><span class="p">)</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve_triangular</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">L0</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve_triangular</span><span class="p">(</span><span class="n">L1</span><span class="p">,</span> <span class="n">mu1</span> <span class="o">-</span> <span class="n">mu0</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">kl</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">M</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">mu0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">L1</span><span class="p">))</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">L0</span><span class="p">)))</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">kl</span>


<span class="k">def</span> <span class="nf">_compute_proposal_dist</span><span class="p">(</span><span class="n">mean_prior</span><span class="p">,</span> <span class="n">cov_prior</span><span class="p">,</span> <span class="n">dF_mean_ll</span><span class="p">,</span> <span class="n">dF_prec_ll</span><span class="p">):</span>
    <span class="n">prec_prior</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_prior</span><span class="p">)</span>
    <span class="n">prec</span> <span class="o">=</span> <span class="n">dF_prec_ll</span> <span class="o">+</span> <span class="n">prec_prior</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dF_prec_ll</span><span class="p">,</span> <span class="n">dF_mean_ll</span><span class="p">)</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">prec_prior</span><span class="p">,</span> <span class="n">mean_prior</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov</span>


<span class="k">def</span> <span class="nf">_print_params</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;beta: &quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">][</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">][</span><span class="s2">&quot;beta&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, &#39;</span>

    <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;scale: </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">][</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, &#39;</span>

    <span class="n">res</span> <span class="o">+=</span> <span class="s2">&quot;l_scale: &quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">][</span><span class="s2">&quot;length_scale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">][</span><span class="s2">&quot;length_scale&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, &#39;</span>

    <span class="k">if</span> <span class="s2">&quot;alpha&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;alpha: </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">][</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, &#39;</span>

    <span class="n">res</span> <span class="o">+=</span> <span class="s2">&quot;dscale: &quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">][</span><span class="s2">&quot;dscale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">][</span><span class="s2">&quot;dscale&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">, &#39;</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">_expand</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
        <span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xx</span>


<span class="k">def</span> <span class="nf">_mean</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">_expand</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">xx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_params_from_raw</span><span class="p">(</span><span class="n">raw_params</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_kernel_params_from_raw</span><span class="p">(</span><span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">params</span>


<span class="k">def</span> <span class="nf">_params_to_raw</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">raw_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
    <span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_kernel_params_to_raw</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">raw_params</span>


<span class="k">def</span> <span class="nf">_init_mean_params</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">dF</span><span class="p">,</span> <span class="n">state_cv</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">_expand</span><span class="p">(</span><span class="n">state_cv</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dF</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="n">beta</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">params</span>


<span class="k">def</span> <span class="nf">_init_params</span><span class="p">(</span><span class="n">mean_order</span><span class="p">,</span> <span class="n">kernel_name</span><span class="p">,</span> <span class="n">dF</span><span class="p">,</span> <span class="n">state_cv</span><span class="p">,</span> <span class="n">num_conf</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_init_mean_params</span><span class="p">(</span><span class="n">mean_order</span><span class="p">,</span> <span class="n">dF</span><span class="p">,</span> <span class="n">state_cv</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;kernel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_init_kernel_params</span><span class="p">(</span><span class="n">kernel_name</span><span class="p">,</span> <span class="n">dF</span><span class="p">,</span> <span class="n">state_cv</span><span class="p">,</span> <span class="n">num_conf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params</span>


<span class="k">def</span> <span class="nf">_init_kernel_params</span><span class="p">(</span><span class="n">kernel_name</span><span class="p">,</span> <span class="n">dF</span><span class="p">,</span> <span class="n">state_cv</span><span class="p">,</span> <span class="n">num_conf</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dF</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;length_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">state_cv</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">state_cv</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">state_cv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;dscale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dF</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dF</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kernel_name</span> <span class="o">==</span> <span class="s2">&quot;RQ&quot;</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,))</span> <span class="o">*</span> <span class="mi">10</span>

    <span class="k">return</span> <span class="n">params</span>


<span class="k">def</span> <span class="nf">_kernel_RQ</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span>
    <span class="n">length_scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;length_scale&quot;</span><span class="p">]</span>
    <span class="n">dscale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;dscale&quot;</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">length_scale</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">_compute_squared_distance</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scale</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ds</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">dscale</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_kernel_SE</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span>
    <span class="n">length_scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;length_scale&quot;</span><span class="p">]</span>
    <span class="n">dscale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;dscale&quot;</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">length_scale</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">_compute_squared_distance</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scale</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">ds</span><span class="p">)</span> <span class="o">+</span> <span class="n">dscale</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_kernel_Matern52</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span>
    <span class="n">length_scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;length_scale&quot;</span><span class="p">]</span>
    <span class="n">dscale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;dscale&quot;</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">length_scale</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">_compute_squared_distance</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ds</span> <span class="o">+</span> <span class="mf">1e-18</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scale</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span> <span class="o">+</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">ds</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
        <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span>
    <span class="p">)</span> <span class="o">+</span> <span class="n">dscale</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_kernel_Matern32</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span>
    <span class="n">length_scale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;length_scale&quot;</span><span class="p">]</span>
    <span class="n">dscale</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;dscale&quot;</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">length_scale</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">_compute_squared_distance</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ds</span> <span class="o">+</span> <span class="mf">1e-18</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scale</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
        <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span>
    <span class="p">)</span> <span class="o">+</span> <span class="n">dscale</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_kernel_params_from_raw</span><span class="p">(</span><span class="n">raw_params</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;raw_scale&quot;</span><span class="p">])</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;length_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;raw_length_scale&quot;</span><span class="p">])</span>
    <span class="n">params</span><span class="p">[</span><span class="s2">&quot;dscale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;raw_dscale&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;raw_alpha&quot;</span> <span class="ow">in</span> <span class="n">raw_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;raw_alpha&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">params</span>


<span class="k">def</span> <span class="nf">_kernel_params_to_raw</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">raw_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;raw_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;raw_length_scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;length_scale&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;raw_dscale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;dscale&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;alpha&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">raw_params</span><span class="p">[</span><span class="s2">&quot;raw_alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">raw_params</span>


<span class="k">def</span> <span class="nf">_compute_squared_distance</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_sample_from_logdensity</span><span class="p">(</span>
    <span class="n">rng_key</span><span class="p">,</span> <span class="n">init_dF</span><span class="p">,</span> <span class="n">logdensity</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">verbose</span>
<span class="p">):</span>
    <span class="c1">## warmup to find step size and mass matrix</span>
    <span class="n">warmup</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">window_adaptation</span><span class="p">(</span>
        <span class="n">blackjax</span><span class="o">.</span><span class="n">nuts</span><span class="p">,</span>
        <span class="n">logdensity</span><span class="p">,</span>
        <span class="n">is_mass_matrix_diagonal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">progress_bar</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">rng_key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
    <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">parameters</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">warmup</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">init_dF</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="n">warmup_steps</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sample using the NUTS sampler&quot;</span><span class="p">)</span>

    <span class="c1">## sample using nuts</span>

    <span class="c1"># ## Use the blackjax.util.run_inference_algorithm function to run the nuts algorithm</span>
    <span class="c1"># ## so that we can have a progress bar. It is a wrap of _sample_loop.   </span>
    <span class="c1"># alg = blackjax.nuts(logdensity, **parameters)</span>
    <span class="c1"># _, states, _ = blackjax.util.run_inference_algorithm(</span>
    <span class="c1">#     rng_key, state, alg, num_samples, progress_bar=verbose</span>
    <span class="c1"># )</span>

    <span class="c1">## sample using nuts</span>
    <span class="n">rng_key</span><span class="p">,</span> <span class="n">subkey</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">blackjax</span><span class="o">.</span><span class="n">nuts</span><span class="p">(</span><span class="n">logdensity</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">)</span><span class="o">.</span><span class="n">step</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">_sample_loop</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">states</span><span class="o">.</span><span class="n">position</span>


<span class="k">def</span> <span class="nf">_sample_loop</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">):</span>
    <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
    <span class="k">def</span> <span class="nf">one_step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">rng_key</span><span class="p">):</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">state</span>

    <span class="n">keys</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">one_step</span><span class="p">,</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">states</span>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Xinqiang Ding
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2024, Xinqiang Ding.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>